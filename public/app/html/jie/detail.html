<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>详情页</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="keywords" content="fly,layui,前端社区">
  <meta name="description" content="Fly社区是模块化前端UI框架Layui的官网社区，致力于为web开发提供强劲动力">
  <link rel="stylesheet" href="../../res/layui/css/layui.css">
  <link rel="stylesheet" href="../../res/css/global.css">
  <link rel="stylesheet" href="../../res/layui/css/layui.mobile.css">
</head>
<body>

<div class="fly-header layui-bg-black">
  <div class="layui-container">
    <a class="fly-logo" href="/">
      <img src="../../res/images/logo.png" alt="layui">
               首页
    </a>
     <ul class="layui-nav fly-nav layui-hide-xs">
      <li class="layui-nav-item layui-this">
        <a href="/index.html"><i class="iconfont icon-jiaoliu"></i>首页</a>
      </li>
     </ul>
    <ul class="layui-nav fly-nav-user">
      
      <!-- 未登入的状态 -->
      <li class="layui-nav-item unlogin">
        <a href="user/login.html ">登入</a>
      </li>
      <li class="layui-nav-item unlogin">
        <a href="user/reg.html">注册</a>
      </li>
      <!-- 登入后的状态 -->
      <li class="layui-nav-item login">
        <a class="fly-nav-avatar" href="javascript:;">
          <cite class="layui-hide-xs" id='username'></cite>
          <img id='icon' src="#">
        </a>
        <dl class="layui-nav-child">
        	<dd><a href="user/set.html"><i class="layui-icon">&#xe620;</i>用户中心</a></dd>
          <dd><a href="user/set.html"><i class="layui-icon">&#xe620;</i>基本设置</a></dd>
          <dd><a href="user/message.html"><i class="iconfont icon-tongzhi" style="top: 4px;"></i>我的消息</a></dd>
          <hr style="margin: 5px 0;">
          <dd><a id='logout' style="text-align: center;">退出</a></dd>
        </dl>
      </li>
      
    </ul>
   </div>
</div>
<div class="layui-container">
  <div class="layui-row layui-col-space15">
    <div class="layui-col-md12 content detail">
      <div class="fly-panel detail-box" >
        <h1 style="text-align: center;" id='name'></h1>

        <div class="fly-detail-info">
          <span class="layui-badge layui-bg-red fly-detail-column" id='prev'>前一天</span>
          <button class="layui-btn layui-btn-radius layui-btn-normal" id='buy'>
      	  		买入
      	  	</button>
          <span class="fly-list-nums"> 
          		<button class="layui-btn layui-btn-radius layui-btn-normal" id='sail'>
    					卖出
    				</button>
          		<span class="layui-badge layui-bg-red" id='next'>后一天</span>
          		
          </span>
        </div>
        <div class="detail-about">
        	<p>当前价格:<span id="current_price">0.00</span></p>
        	<p>我拥有:<span id="has">0</span></p>
        </div>
        <div class="detail-body photos" id='main2'></div>
      </div>
    </div>
   </div>
</div>

<div class="fly-footer">
</div>

<script src="../../res/layui/layui.js"></script>
<script src='../../res/my/config.js'></script>
<script src="../../res/my/echarts.js"></script>
<script>
	var layer;
	var form;
	layui.use('form',function(){
		window.form=layui.form;
		var $=layui.$;
		$('#logout').click(function(){
			$.post(config.domain+'api/user/logout.html',{token:localStorage.getItem('token')},function(response){
				if(response.code==1){
					localStorage.clear();
					location.href='/index.html';
				}
				layer.msg('退出失败',{time:2*1000})
			})
		})
		
		form.on('submit(buy)',function(data){
			if(data.field.price<=0){
				layer.msg('不在交易时间内',{time:2*1000});
				return false;
			}
			var l=$.extend(data.field,{token:localStorage.getItem('token'),code:localStorage.getItem('code')});
			$.post(config.domain+'api/trade/buy',l,function(response){
				layer.msg(response.msg, {
					  time: 2000, //2s后自动关闭
					});
				if(response.code==1){
					var l=parseInt($('#has').text())+parseInt(data.field.number);
					$('#has').text(l);
				}
				});
			return false;
		});
		form.on('submit(sail)',function(data){
			if(data.field.price<=0){
				layer.msg('不在交易时间内',{time:2*1000});
				return false;
			}
			var l=$.extend(data.field,{token:localStorage.getItem('token'),code:localStorage.getItem('code')});
			$.post(config.domain+'api/trade/sail',l,function(response){
				layer.msg(response.msg, {
					  time: 2000, //2s后自动关闭
					});
				if(response.code==1){
					var l=parseInt($('#has').text())-parseInt(data.field.number);
					$('#has').text(l);
				}
				});
			return false;
		});
	});
layui.use('element',function(){
	var element=layui.element;
})
layui.use('mobile',function(){
	window.layer=layui.mobile.layer;
})
layui.use('jquery', function(){
  var $ = layui.$;
  $(function(){
  	if(localStorage.getItem('userInfo')){
		  	$('.unlogin').hide();
		  	$('.login').show();
		  	var userInfo=JSON.parse(localStorage.getItem('userInfo'));
		  	var icon=userInfo.avatar?userInfo.avatar:config.default_icon;
		  	$('#username').text(userInfo.username);
		  	$('#icon').attr('src',icon);
		  }else{
		  	$('.login').hide();
		  	$('.unlogin').show();
		  };
  })
	layui.jquery=$;
  var myChart = echarts.init(document.getElementById('main2'));
	var option = {
    backgroundColor: '#21202D',
    tooltip: {
        trigger: 'axis',
        axisPointer: {
            animation: false,
            type: 'cross',
            lineStyle: {
                color: '#376df4',
                width: 2,
                opacity: 1
            }
        },
        formatter:function(params){
        	return '时间:'+params[0].axisValue+'<br/>价格:'+params[0].data;
        }
    },
    xAxis: {
        type: 'category',
        axisLine: { lineStyle: { color: '#8392A5' } }
    },
    yAxis: {
        scale: true,
        axisLine: { lineStyle: { color: '#8392A5' } },
        splitLine: { show: false },
      	min:function(value){
      		return value.min*0.8;
      	},
      	max:function(value){
      		return value.max*1.2;
      	}
    },
    grid: {
        bottom: 80
    },
    animation: false,
    series: [
        {
            name: 'shares',
            type: 'line',
            smooth: true,
            showSymbol: false,
            lineStyle: {
                normal: {
                    width: 1
                }
            }
        }
    ]
};
	myChart.setOption(option, true);
	myChart.showLoading();
	var a1=[],b1=[],a2=[],b2=[];
	$.post(config.domain+'api/show_k/index.html',{code:localStorage.getItem('code'),'token':localStorage.getItem('token')},function(response){
		$('#name').text(response.data.name);
		$('#has').text(response.data.has);
		$('#prev').data('date',response.data.prev);
		$('#next').data('date',response.data.next);
		
		myChart.hideLoading();
		var c=new Date();
		var h=c.getHours();
		var m=c.getMinutes();
		if(h<10){
			h='0'+h;
		}
		if(m<10){
			m='0'+m;
		}
		var index=response.data.key.indexOf(h+':'+m);
		if(response.data.is_all){
			a1=[];
			b1=[];
			a2=response.data.key;
			b2=response.data.value;
		}else{
			a1=response.data.key.slice(index-1);
			a2=response.data.key.slice(0,index);
			b1=response.data.value.slice(index-1);
			b2=response.data.value.slice(0,index);
		}
		$('#current_price').text(b2[index-1]);
		var tmp={
			title:{
				text:response.data.current,
			},
			xAxis:{
				data:a2
			},
			series:[
				{
					name:'shares',
					data:b2
				}
			]
		};
		myChart.setOption(tmp);
});
var i=setInterval(function(){
	if(a1.length==0){
		clearInterval(i);
		return '';
	}
	var price=b1.splice(0,1)[0];
	a2.push(a1.splice(0,1)[0]);
	b2.push(price);
	$('#current_price').text(price);
	myChart.setOption({
		xAxis:{
			data:a2
		},
		series:[
			{
				name:'shares',
				data:b2
			}
		]
	})
},60*1000);
$('#buy').click(function(){
	 layer.open({
    title: [
      '买入',
      'background-color: #FF4351; color:#fff;'
    ]
    ,content:'<form class="layui-form" action="">'+
    ' <div class="layui-form-item">'+
    '<label class="layui-form-label">买入数量</label>'+
    '<div class="layui-input-block">'+
     ' <input type="text" name="number" required  lay-verify="required" placeholder="请输入数量" autocomplete="off" value="" class="layui-input">'+
    '</div>'+
  '</div>'+
  ' <div class="layui-form-item">'+
    '<label class="layui-form-label">买入价格</label>'+
    '<div class="layui-input-block">'+
     ' <input type="number" name="price" required  lay-verify="required" id="buy_price" placeholder="买入价格" readonly="readonly" autocomplete="off" value="0" class="layui-input">'+
    '</div>'+
  '</div>'+
'  <div class="layui-form-item">'+
   ' <div class="layui-input-block">'+
     ' <button class="layui-btn" lay-submit lay-filter="buy">购买</button>'+
      '<button type="reset" class="layui-btn layui-btn-primary" onclick="layer.closeAll()">关闭</button>'+
    '</div>'+
  '</div>'+
    '</form>',
    success:function(dom,index){
    	$(dom).find('#buy_price').val($('#current_price').text());
    }
  });
  $('.layui-layer .layui-layer-btn').remove();
});
$('#sail').click(function(){
	 layer.open({
    title: [
      '卖出',
      'background-color: #FF4351; color:#fff;'
    ]
    ,content:'<form class="layui-form" action="">'+
    ' <div class="layui-form-item">'+
    '<label class="layui-form-label">买出数量</label>'+
    '<div class="layui-input-block">'+
     ' <input type="text" name="number" required  lay-verify="required" placeholder="贩卖数量" autocomplete="off" value="" class="layui-input">'+
    '</div>'+
  '</div>'+
  ' <div class="layui-form-item">'+
    '<label class="layui-form-label">买出价格</label>'+
    '<div class="layui-input-block">'+
     ' <input type="number" name="price" required  lay-verify="required" id="sail_price" placeholder="卖出价格" readonly="readonly" autocomplete="off" value="0" class="layui-input">'+
    '</div>'+
  '</div>'+
'  <div class="layui-form-item">'+
   ' <div class="layui-input-block">'+
     ' <button class="layui-btn" lay-submit lay-filter="sail">卖出</button>'+
      '<button type="reset" class="layui-btn layui-btn-primary" onclick="layer.closeAll()">关闭</button>'+
    '</div>'+
  '</div>'+
    '</form>',
    success:function(dom,index){
    	$(dom).find('#sail_price').val($('#current_price').text());
    }
  });
  $('.layui-layer .layui-layer-btn').remove();
});

$('#prev,#next').click(function(){
	var _self=$(this);
	myChart.showLoading();
var a1=[],b1=[],a2=[],b2=[];
$.post(config.domain+'api/show_k/index.html',{date:_self.data('date'),code:localStorage.getItem('code'),'token':localStorage.getItem('token')},function(response){
		if(response.code!=1){
			layer.msg(respnse.msg);
			return '';
		}
		$('#name').text(response.data.name);
		$('#has').text(response.data.has);
		$('#prev').data('date',response.data.prev);
		$('#next').data('date',response.data.next);
		myChart.hideLoading();
		var c=new Date();
		var h=c.getHours();
		var m=c.getMinutes();
		if(h<10){
			h='0'+h;
		}
		if(m<10){
			m='0'+m;
		}
		var index=response.data.key.indexOf(h+':'+m)
		if(response.data.is_all){
			a1=[];
			b1=[];
			a2=response.data.key;
			b2=response.data.value;
		}else{
			a1=response.data.key.slice(index);
			a2=response.data.key.slice(0,index);
			b1=response.data.value.slice(index);
			b2=response.data.value.slice(0,index);
		}
		var tmp={
			title:{
				text:response.data.current,
			},
			xAxis:{
				data:a2
			},
			series:[
				{
					name:'shares',
					data:b2
				}
			]
		};
		myChart.setOption(tmp);
});

})
});


</script>
</body>
</html>